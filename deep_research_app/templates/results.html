<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Research: {{ topic }}</title>
    <link rel="stylesheet" href="{{ pico_css }}">
    <!-- Tippy.js for interactive footnotes -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <style>
        body { padding-bottom: 5rem; } /* Prevent content hiding behind footer */
        main { padding-top: 1rem; }
        #progress-updates { max-height: 300px; overflow-y: auto; background-color: var(--card-background-color); border: 1px solid var(--card-border-color); padding: 1rem; margin-bottom: 1.5rem; border-radius: var(--border-radius); font-size: 0.9em; }
        #progress-updates p { margin-bottom: 0.5em; }
        #progress-updates .error { color: var(--pico-color-red-500); font-weight: bold; }
        #final-report-container article { margin-top: 2rem; padding: 1.5rem; border: 1px solid var(--card-border-color); border-radius: var(--border-radius); background-color: var(--card-background-color); }
        /* Markdown Styles */
        #final-report-html h1, #final-report-html h2, #final-report-html h3 { margin-top: 1.5em; margin-bottom: 0.8em; }
        #final-report-html h1 { border-bottom: 2px solid var(--primary); padding-bottom: 0.3em; }
        #final-report-html h2 { border-bottom: 1px solid var(--secondary); padding-bottom: 0.2em; }
        #final-report-html p { line-height: 1.6; }
        #final-report-html ul, #final-report-html ol { margin-left: 2em; margin-bottom: 1em; }
        #final-report-html blockquote { border-left: 4px solid var(--muted-border-color); padding-left: 1em; margin-left: 0; color: var(--muted-color); }
        #final-report-html pre { background-color: var(--code-background-color); padding: 1em; border-radius: var(--border-radius); overflow-x: auto; }
        #final-report-html code { font-family: var(--font-monospace); background-color: var(--code-background-color); padding: 0.2em 0.4em; border-radius: 3px; }
        #final-report-html pre code { background-color: transparent; padding: 0; }
        #final-report-html .footnote-ref a { /* Style the [^1] links */
            background-color: var(--primary-background); color: var(--primary); padding: 1px 4px; border-radius: 3px; text-decoration: none; font-size: 0.85em; vertical-align: super;
        }
        #final-report-html .footnote-ref a:hover { background-color: var(--primary-hover); }
        #final-report-html .footnotes { margin-top: 2em; padding-top: 1em; border-top: 1px solid var(--muted-border-color); font-size: 0.9em; color: var(--muted-color); }
        #final-report-html .footnotes ol { margin-left: 1em; }
        #final-report-html .footnotes li { margin-bottom: 0.5em; }
        #final-report-html .footnotes p { display: inline; } /* Prevent extra paragraphs in footnotes */
        /* Tippy.js Tooltip Style */
        .tippy-box[data-theme~='light-border'] {
            border: 1px solid var(--primary);
            background-color: var(--card-background-color);
            color: var(--color);
        }
        .tippy-box[data-theme~='light-border'][data-placement^='top'] > .tippy-arrow::before { border-top-color: var(--primary); }
        .tippy-box[data-theme~='light-border'][data-placement^='bottom'] > .tippy-arrow::before { border-bottom-color: var(--primary); }
        .tippy-box[data-theme~='light-border'][data-placement^='left'] > .tippy-arrow::before { border-left-color: var(--primary); }
        .tippy-box[data-theme~='light-border'][data-placement^='right'] > .tippy-arrow::before { border-right-color: var(--primary); }
        .tippy-content { word-break: break-all; } /* Allow long URLs to wrap */
    </style>
</head>
<body>
    <nav class="container-fluid">
        <ul>
            <li><a href="/" class="contrast"><strong>Deep Research Assistant</strong></a></li>
        </ul>
        <ul>
            <li>
                <a href="{{ url_for('index') }}" role="button" class="outline">New Research</a>
            </li>
        </ul>
    </nav>

    <main class="container">
        <section id="topic-section">
            <h2 style="word-break: break-word;">Researching: {{ topic }}</h2>
            <a href="{{ url_for('index') }}" role="button" class="secondary outline">‚Üê Start New Research</a>
        </section>

        <section id="progress-section">
            <h3>Research Progress</h3>
            <div id="progress-updates">
                <p>Initializing research process...</p>
            </div>
            <progress id="progress-bar" style="display: none;"></progress> <!-- Optional: Visual progress bar -->
        </section>

        <section id="synthesis-output-container" style="display: none;">
            <h3>Synthesized Information (Live)</h3>
            <article>
                <div id="synthesis-output"></div>
            </article>
        </section>

        <section id="final-report-container" style="display: none;">
            <h3>Final Research Report</h3>
            <form id="download-form" action="{{ url_for('download_docx') }}" method="post" style="margin-bottom: 1rem; display: none;">
                <input type="hidden" name="markdown_report" id="markdown_report_hidden">
                <input type="hidden" name="topic" value="{{ topic }}">
                {# Disable button if conversion not available - handled via JS #}
                <button type="submit" id="download-docx-button">Download as DOCX</button>
                <small id="docx-unavailable-msg" style="display: none; color: var(--muted-color); margin-left: 1em;">DOCX download requires the 'html2docx' library on the server.</small>
            </form>
            <article>
                <div id="final-report-html">
                    <p><i>Final report will be generated here...</i></p>
                </div>
            </article>
        </section>

        <details id="raw-data-preview-container" style="display: none; margin-top: 2rem;">
            <summary>Raw Scraped Data Preview (Limited)</summary>
            <h3>Raw Scraped Data Preview (Limited)</h3>
            <pre><code id="raw-data-content" style="font-size: 0.8em; max-height: 400px; overflow-y: auto; display: block;"></code></pre>
        </details>

        <div id="error-container" class="container" style="margin-top: 2rem; display: none;">
             <article class="error-message" style="background-color: var(--pico-form-element-invalid-background-color); border-color: var(--pico-form-element-invalid-border-color); color: var(--pico-form-element-invalid-active-color);">
                <h4 style="color: inherit;">An Error Occurred</h4>
                <p id="error-message-text"></p>
                <button onclick="document.getElementById('error-container').style.display='none'">Dismiss</button>
            </article>
        </div>

    </main>

    <footer class="container" style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
        <small>Powered by Google Gemini & Web Research</small>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
         const encodedTopic = "{{ encoded_topic }}";
         const progressUpdates = document.getElementById('progress-updates');
         const progressBar = document.getElementById('progress-bar'); // Optional progress bar
         const synthesisContainer = document.getElementById('synthesis-output-container');
         const synthesisOutput = document.getElementById('synthesis-output');
         const finalReportContainer = document.getElementById('final-report-container');
         const finalReportHtml = document.getElementById('final-report-html');
         const downloadForm = document.getElementById('download-form');
         const markdownReportHidden = document.getElementById('markdown_report_hidden');
         const downloadDocxButton = document.getElementById('download-docx-button');
         const docxUnavailableMsg = document.getElementById('docx-unavailable-msg');
         const rawDataPreviewContainer = document.getElementById('raw-data-preview-container');
         const rawDataContent = document.getElementById('raw-data-content');
         const errorContainer = document.getElementById('error-container');
         const errorMessageText = document.getElementById('error-message-text');

         // --- Event Source Setup ---
         const eventSource = new EventSource(`/stream?topic=${encodedTopic}`);

         addProgress("Connecting to research stream...");

         function addProgress(message, isError = false) {
             const p = document.createElement('p');
             // Basic sanitization: replace < and > to prevent accidental HTML injection in progress messages
             p.textContent = message.replace(/</g, "<").replace(/>/g, ">");
             if (isError) {
                 p.classList.add('error');
             }
             progressUpdates.appendChild(p);
             // Auto-scroll to the bottom
             progressUpdates.scrollTop = progressUpdates.scrollHeight;

             // Optional: Update progress bar vaguely (e.g., indeterminate)
             if (progressBar) progressBar.style.display = 'block';
         }

         eventSource.onmessage = function(event) {
             const data = JSON.parse(event.data);
             console.log("SSE Event received:", data); // Debug log

             switch (data.type) {
                 case 'progress':
                     addProgress(data.message);
                     break;

                 case 'stream_start':
                     // Show the relevant output container
                     if (data.target === 'synthesis') {
                         synthesisContainer.style.display = 'block';
                         synthesisOutput.innerHTML = ''; // Clear previous content if any
                         addProgress("Receiving synthesized information stream...");
                     } else if (data.target === 'report') {
                         // Clear previous report content if re-running logic allows it
                         finalReportContainer.style.display = 'block'; // Show container early
                         finalReportHtml.innerHTML = '<p><i>Generating final report...</i></p>';
                         downloadForm.style.display = 'none'; // Hide download until ready
                         addProgress("Receiving final report stream...");
                     }
                     break;

                 case 'llm_chunk':
                      // Append chunks to the correct target
                      if (data.target === 'synthesis') {
                          // Check if the synthesis output container is visible
                         if (synthesisContainer.style.display !== 'block') {
                             synthesisContainer.style.display = 'block';
                             synthesisOutput.innerHTML = ''; // Clear if wasn't visible before
                         }
                         // Append content - assuming LLM generates markdown/text
                         // We don't render markdown live here, just show raw stream
                          const cleanedChunk = data.content.replace(/</g, "<").replace(/>/g, ">");
                         synthesisOutput.innerHTML += cleanedChunk; // Append cleaned text chunk

                     } else if (data.target === 'report') {
                         // For the report, we wait for 'complete' to render the full HTML
                         // We could show raw chunks here too if desired, similar to synthesis:
                          // if (finalReportHtml.innerHTML.includes('<i>Generating final report...</i>')) {
                          //     finalReportHtml.innerHTML = ''; // Clear placeholder on first chunk
                          // }
                          // finalReportHtml.innerHTML += data.content.replace(/</g, "<").replace(/>/g, ">"); // Append cleaned chunk
                     }
                     break;

                 case 'complete':
                     finalReportContainer.style.display = 'block';
                     finalReportHtml.innerHTML = data.report_html; // Render final HTML
                     markdownReportHidden.value = data.report_markdown; // Store raw markdown for download
                     // Enable/disable DOCX download based on server flag
                     if (data.docx_available) {
                         downloadDocxButton.disabled = false;
                         downloadForm.style.display = 'inline-block'; // Show form
                         docxUnavailableMsg.style.display = 'none';
                     } else {
                         downloadDocxButton.disabled = true;
                          downloadForm.style.display = 'inline-block'; // Still show the form area
                         downloadDocxButton.style.display = 'none'; // Hide the button itself
                         docxUnavailableMsg.style.display = 'inline'; // Show explanation
                     }

                     // Show raw data preview
                     rawDataPreviewContainer.style.display = 'block';
                     rawDataContent.textContent = data.raw_scraped_data_preview;

                     // Initialize Tippy.js for footnote tooltips *after* content is rendered
                     initializeFootnoteTooltips();

                     addProgress("Processing complete. Report generated.");
                     if (progressBar) progressBar.style.display = 'none'; // Hide progress bar
                     break;

                 case 'error':
                     addProgress(`ERROR: ${data.message}`, true);
                     // Show dedicated error message area
                     errorMessageText.textContent = data.message;
                     errorContainer.style.display = 'block';
                     if (data.fatal) {
                         addProgress("A fatal error occurred. Stopping process.", true);
                         eventSource.close(); // Stop listening on fatal errors
                         if (progressBar) progressBar.style.display = 'none';
                     }
                     break;

                 case 'stream_terminated':
                     addProgress("Server stream finished.");
                     eventSource.close();
                     if (progressBar) {
                          // Set progress bar to 100% or hide it
                          progressBar.removeAttribute('value'); // Make it indeterminate if needed, or hide
                          progressBar.style.display = 'none';
                     }
                     // If the report hasn't been displayed yet (e.g., due to error before 'complete')
                     // ensure the placeholder is removed or an error message is shown.
                     if (finalReportContainer.style.display === 'none' && errorContainer.style.display === 'none') {
                          // If no report and no specific error shown, indicate incomplete process
                          errorMessageText.textContent = "The research process finished, but the final report could not be generated or displayed.";
                          errorContainer.style.display = 'block';
                     }
                     break;
             }
         };

         eventSource.onerror = function(err) {
             console.error("EventSource failed:", err);
             addProgress("Connection error with the research stream. The process might have been interrupted.", true);
             errorMessageText.textContent = "Lost connection to the server. Please check your network or try starting a new research.";
             errorContainer.style.display = 'block';
             eventSource.close();
             if (progressBar) progressBar.style.display = 'none';
         };

         // --- Footnote Tooltip Initialization ---
         function initializeFootnoteTooltips() {
             // Target the footnote reference links generated by the markdown library
             // Example selector: a inside sup element with class footnote-ref
             const footnoteRefs = finalReportHtml.querySelectorAll('.footnote-ref a');

             footnoteRefs.forEach(link => {
                 const targetId = link.getAttribute('href'); // Should be like '#fn:1'
                 if (!targetId || !targetId.startsWith('#fn:')) return;

                 const footnoteElement = finalReportHtml.querySelector(targetId); // Find the corresponding li
                 if (footnoteElement) {
                     // Extract the source URL (often the first link in the footnote li)
                     const sourceLink = footnoteElement.querySelector('a[href^="http"]');
                     let tooltipContent = 'Source info not found.';
                     if (sourceLink) {
                         // Make the URL clickable inside the tooltip
                          tooltipContent = `<a href="${sourceLink.href}" target="_blank" rel="noopener noreferrer">${sourceLink.href}</a>`;
                     } else {
                          // Fallback: try to get text content, remove the back-arrow link if present
                         const backArrow = footnoteElement.querySelector('.footnote-backref');
                         if(backArrow) backArrow.remove(); // Temporarily remove back-arrow for clean text
                         tooltipContent = footnoteElement.textContent.trim();
                          // Add back the arrow if needed for other purposes, though removing is usually fine here
                     }

                     tippy(link, {
                         content: tooltipContent,
                         allowHTML: true, // Allow the link tag in the tooltip
                         interactive: true, // Allow clicking the link in the tooltip
                         theme: 'light-border', // Use the custom theme defined in CSS
                         placement: 'top', // Or 'bottom', 'left', 'right'
                     });
                 }
             });
         }

     });
    </script>
</body>
</html>